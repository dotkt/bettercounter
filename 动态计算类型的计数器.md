# 功能需求文档：动态计算计数器

- **版本**: 1.0
- **日期**: 2026-01-18
- **作者**: Gemini

---

## 1. 概述

### 1.1. 功能简介

本项目旨在为 "BetterCounter" 应用引入一种全新的计数器类型——**动态计算计数器**。与现有的“标准”计数器不同，动态计数器的值并非通过用户直接点击“+1”或“-1”来改变，而是通过一个用户自定义的公式，根据其他一个或多个计数器的值自动计算得出。

### 1.2. 用户价值

此功能允许用户创建“元计数器”，用于追踪更高维度的聚合数据。用户无需再手动计算多个计数器的总和或差值，从而实现更强大的数据自动化追踪。

**典型用例:**

- **净液体摄入量**: `喝水 + 喝茶 - 喝咖啡`
- **今日总任务**: `sum(工作分类) + sum(学习分类)`
- **每日剩余预算**: `预算初始值 - sum(消费分类)`

---

## 2. 详细功能需求

### 2.1. 新的计数器类型

- 系统需新增一个计数器类型：“动态计算”（Dynamic）。
- 现有的普通计数器归类为：“标准”（Standard）。

### 2.2. 核心行为

1.  **只读性**: 动态计算计数器是**只读**的。用户不能直接对其进行增加或减少操作。在UI上，其对应的 `+` 和 `-` 按钮将被禁用或隐藏。
2.  **自动计算**: 它的值完全由其绑定的**计算公式**决定。
3.  **实时更新**: 当公式中引用的任何一个“标准”计数器的值发生变化（增加、减少、重置等）时，所有依赖于它的“动态计算”计数器的值都必须**自动重新计算并更新**。
4.  **启动时计算**: 应用启动或小部件（Widget）创建时，动态计算计数器必须**立即自动计算并显示其初始值**，无需等待其依赖项发生变化。

### 2.3. 计算公式

#### 2.3.1. 语法规则

公式是一个由**操作数**和**操作符**组成的字符串。

-   **操作数 (Operands)**:
    1.  `计数器名称`: 直接使用一个已存在的“标准”计数器的名称。名称需完全匹配。
    2.  `sum(分类名称)`: 一个特殊的函数，用于计算指定**分类**下所有“标准”计数器的当前值总和。**注意：动态计算计数器（DYNAMIC type）不会被计入此总和。**
    3.  `数字常量`: 直接在公式中使用整数 (例如: `... * 10`)。

-   **操作符 (Operators)**:
    1.  `+` (加法)
    2.  `-` (减法)
    3.  `*` (乘法)

-   **解析规则**:
    -   遵循常规的运算优先级（先乘法，后加减）。
    -   公式从左到右进行解析。
    -   支持连续的加减法运算。
    -   操作数和操作符之间可以用空格分隔，也可以不分隔，解析时应忽略空格。

#### 2.3.2. 示例公式

- `sum(饮料)-咖啡因饮料`
- `工作任务+学习任务+家务任务`
- `sum(收入)-sum(支出)`
- `sum(儿子)-泽熙兑换*2`

### 2.4. 用户界面 (UI) 与交互 (UX)

1.  **创建/编辑计数器**:
    -   在“添加/编辑计数-器”对话框中，增加一个选项（如单选按钮组）让用户选择计数器类型：“标准”或“动态计算”。
    -   当用户选择“标准”时，界面与当前保持一致（但无减计数按钮）。
    -   当用户选择“动态计算”时：
        -   隐藏/禁用“初始值”、“目标”等与直接计数相关的输入框。
        -   显示一个**文本输入框**，用于用户输入**计算公式**。
    -   **公式验证**:
        -   系统需要对输入的公式进行实时或提交时验证。
        -   验证内容包括：基础语法、引用的 `计数器名称` 和 `分类名称` 是否真实存在。
        -   如果验证失败，需向用户提供清晰的错误提示。
    -   **计数器类型转换**:
        -   **从标准转换为动态计算**: 允许用户将现有标准计数器转换为动态计算计数器。转换时，该计数器原有的所有历史记录数据（Entry）将**被保留在数据库中，但不会影响其自身作为动态计算计数器的值**（即，动态计数器只通过公式计算，不累加自身历史Entry）。这些历史数据在导出时仍可作为该计数器的数据被导出，并且如果该计数器被其他动态计算计数器引用，其历史值仍会被计入计算。
        -   **从动态计算转换为标准 (待议)**: 待考虑此方向的转换需求及具体行为（例如，转换后计数器的初始值应是多少？是否保留其原公式计算的最后值作为初始值？）。

2.  **主列表显示**:
    -   对于**标准计数器**，其 `-` (减计数) 按钮将被**完全移除**，因为计数事件应被视为不可撤销的累积过程。仅保留 `+` 按钮。
    -   动态计算计数器在列表中应有明显的视觉区别，例如为其添加一个特殊图标（如 `ƒ` 或 🖩）。
    -   其 `+` 按钮也应被**完全隐藏**，以明确其只读属性。
    -   用户点击动态计算计数器，仍然可以进入其详情页查看历史数据图表。

3.  **多选模式**:
    -   用户**可以**在多选模式下选择动态计算计数器。
    -   允许的批量操作包括：**修改分类**、**修改颜色** 和 **删除**。

4.  **搜索**:
    -   动态计算计数器应正常出现在搜索结果中。

### 2.5. Widget 交互

-   **标准计数器 Widget**: 其 `-` 按钮将被**移除**，仅保留 `+` 按钮。
-   **动态计算计数器 Widget**: 它将处于**只读状态**。小部件上的 `+` 按钮将被**隐藏**或**视觉上禁用**（灰色）。
-   **交互**: 点击任一小部件的主体部分将打开应用并导航到该计数器的详情页，行为与现有小部件一致。
-   **自动更新**: 当公式所依赖的任何一个标准计数器值发生变化时，小部件上显示的值必须**自动刷新**。支持按分类更新。

## 3. 数据处理与技术实现

### 3.1. 数据模型

-   需要在 `Counter` 数据库实体中增加至少两个字段：
    -   `type`: 字符串或枚举，用于存储类型（`STANDARD` 或 `DYNAMIC`）。
    -   `formula`: 字符串，用于存储计算公式（仅 `DYNAMIC` 类型需要）。

-   **导入导出**: 导出为 CSV 文件时，需要在导出的json中增加两列：`type` 和 `formula`。
    -   标准计数器: `type` 为 `STANDARD`，`formula` 为空。这是当前的默认项
    -   动态计数器: `type` 为 `DYNAMIC`，`formula` 为其计算公式。
### 4.1. 引用完整性

-   **问题**: 如果公式中引用的计数器或分类被**删除**或**重命名**了，该如何处理？
-   **建议**:
    -   **重命名**: 尝试自动更新所有引用该名称的公式。
    -   **删除 (按名称引用)**: 当公式中**按名称直接引用**的计数器被删除时（例如 `公式 = A + B`，而 `A` 被删除），动态计算计数器应进入“错误”或“无效”状态，并在UI上明确提示用户其公式引用已失效，需要修复。
    -   **删除 (sum(分类)引用)**: 当公式通过 `sum(分类)` 间接引用某个计数器时，如果该分类下的某个计数器被删除，公式本身**仍然有效**。系统应自动、安全地重新计算总和，其值将仅反映分类下**剩余**计数器的值。这不会导致动态计数器进入“错误”状态。

### 4.2. 循环依赖

-   **问题**: 如何防止用户创建循环依赖？ (例如: A = B + 1, B = A - 1)
-   **建议**: 在保存公式时进行依赖检测。在解析一个动态计数器时，递归检查其依赖项是否直接或间接依赖于自身。如果检测到循环，则禁止保存并向用户报错。

### 4.3. 更复杂的功能 (V2.0)

-   支持 `/` (除法)。
-   支持括号 `()` 来控制运算优先级。
